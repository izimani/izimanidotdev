---
import Figure from "./Figure.astro";

interface Props {
  caption?: string;
}

const { caption } = Astro.props;
---

<Figure caption={caption}>
  <slot />
  <script>
    import {
      getInitialColorScheme,
      chooseCodeTheme,
      COLOR_SCHEME_CHANGE_EVENT_NAME,
    } from "#util/color-scheme.mjs";

    const CODE_THEME_ATTRIBUTE_NAME = "data-theme";

    const colorScheme = getInitialColorScheme();
    const theme = chooseCodeTheme(colorScheme);

    document.addEventListener("DOMContentLoaded", () => {
      const codeBlocks = document.querySelectorAll(".figure .expressive-code");

      codeBlocks.forEach((codeBlock) => {
        codeBlock.setAttribute(CODE_THEME_ATTRIBUTE_NAME, theme);
      });

      document.addEventListener(COLOR_SCHEME_CHANGE_EVENT_NAME, (event) => {
        const theme = chooseCodeTheme(event.detail.colorScheme);

        codeBlocks.forEach((codeBlock) => {
          codeBlock.setAttribute(CODE_THEME_ATTRIBUTE_NAME, theme);
        });
      });
    });
  </script>
</Figure>
